// packages/@rummikub/analytics/src/tracker.ts
export class AnalyticsTracker {
  private providers: AnalyticsProvider[] = [];
  private queue: AnalyticsEvent[] = [];
  private userId?: string;

  constructor(config: AnalyticsConfig) {
    if (config.mixpanel) {
      this.providers.push(new MixpanelProvider(config.mixpanel));
    }
    if (config.amplitude) {
      this.providers.push(new AmplitudeProvider(config.amplitude));
    }
    if (config.firebase) {
      this.providers.push(new FirebaseProvider(config.firebase));
    }
    
    // Custom backend analytics
    this.providers.push(new BackendProvider(config.apiUrl));
  }

  identify(userId: string, traits?: UserTraits) {
    this.userId = userId;
    this.providers.forEach(p => p.identify(userId, traits));
  }

  track(event: string, properties?: Record<string, any>) {
    const enrichedEvent = {
      event,
      properties: {
        ...properties,
        timestamp: new Date().toISOString(),
        userId: this.userId,
        sessionId: this.getSessionId(),
        platform: this.getPlatform(),
        version: APP_VERSION,
      },
    };

    this.providers.forEach(p => p.track(enrichedEvent));
  }

  // Game-specific tracking
  trackGameStart(gameId: string, settings: GameSettings) {
    this.track('game_started', {
      gameId,
      gameMode: settings.mode,
      betAmount: settings.betAmount,
      timeLimit: settings.timeLimit,
      playerCount: settings.playerCount,
    });
  }

  trackGameEnd(gameId: string, result: GameResult) {
    this.track('game_ended', {
      gameId,
      duration: result.duration,
      winner: result.winnerId,
      finalScores: result.scores,
      totalMoves: result.totalMoves,
    });
  }

  trackPurchase(item: ShopItem, paymentMethod: string) {
    this.track('purchase_completed', {
      itemId: item.id,
      itemName: item.name,
      itemType: item.type,
      price: item.price,
      currency: item.currency,
      paymentMethod,
    });
  }
}